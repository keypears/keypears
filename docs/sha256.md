# Migration Plan: Blake3 to SHA-256

This document outlines the plan to migrate KeyPears from Blake3-based
cryptography to SHA-256-based cryptography for industry standard compliance.

## Rationale

While Blake3 is a modern, fast hash function with excellent security properties,
SHA-256 is the industry standard. For enterprise adoption and compliance
purposes, using SHA-256 allows us to answer "Do you use SHA-256 for hashing?"
with "Yes."

For our use case (hashing small amounts of data with 100k KDF iterations
dominating performance), the speed difference between Blake3 and SHA-256 is
negligible.

## Migration Overview

| Blake3 Component | SHA-256 Equivalent |
| ---------------- | ------------------ |
| `@webbuf/blake3` | `@webbuf/sha256`   |
| `@webbuf/acb3`   | `@webbuf/acs2`     |
| `blake3Hash()`   | `sha256Hash()`     |
| `blake3Mac()`    | `sha256Hmac()`     |
| `acb3Encrypt()`  | `acs2Encrypt()`    |
| `acb3Decrypt()`  | `acs2Decrypt()`    |

Both hash functions produce 32-byte output, so `FixedBuf<32>` types remain
unchanged.

**Breaking Change**: This migration breaks compatibility with any existing
encrypted data. Since we are pre-MVP, this is acceptable.

---

## Phase 1: Update Dependencies

### lib/package.json

- [x] Replace `"@webbuf/acb3": "^3.3.0"` with `"@webbuf/acs2": "^3.3.0"`
- [x] Replace `"@webbuf/blake3": "^3.3.0"` with `"@webbuf/sha256": "^3.3.0"`

### api-server/package.json

- [x] Replace `"@webbuf/blake3": "^3.3.0"` with `"@webbuf/sha256": "^3.3.0"`

### Install dependencies

- [x] Run `pnpm install` from root to update lock file

---

## Phase 2: Update Core Library (lib/src/index.ts)

### Update imports

- [x] Change `import { acb3Decrypt, acb3Encrypt } from "@webbuf/acb3"` to
      `import { acs2Decrypt, acs2Encrypt } from "@webbuf/acs2"`
- [x] Change `import { blake3Hash, blake3Mac } from "@webbuf/blake3"` to
      `import { sha256Hash, sha256Hmac } from "@webbuf/sha256"`

### Update exports

- [x] Change `export { blake3Hash, blake3Mac, acb3Encrypt, acb3Decrypt, ... }`
      to `export { sha256Hash, sha256Hmac, acs2Encrypt, acs2Decrypt, ... }`

### Rename blake3Pbkdf function

- [x] Rename function `blake3Pbkdf` to `sha256Pbkdf`
- [x] Update JSDoc comment to reference SHA-256 instead of Blake3
- [x] Update internal calls from `blake3Mac` to `sha256Hmac`

### Update salt derivation functions

- [x] `derivePasswordSalt`: Replace `blake3Hash` with `sha256Hash`, `blake3Mac`
      with `sha256Hmac`
- [x] `deriveEncryptionSalt`: Replace `blake3Hash` with `sha256Hash`
- [x] `deriveLoginSalt`: Replace `blake3Hash` with `sha256Hash`
- [x] `deriveServerHashedLoginKeySalt`: Replace `blake3Hash` with `sha256Hash`

### Update key derivation functions

- [x] `derivePasswordKey`: Replace `blake3Hash` with `sha256Hash`, `blake3Mac`
      with `sha256Hmac`, `blake3Pbkdf` with `sha256Pbkdf`
- [x] `deriveEncryptionKey`: Replace `blake3Pbkdf` with `sha256Pbkdf`
- [x] `deriveLoginKey`: Replace `blake3Pbkdf` with `sha256Pbkdf`
- [x] `deriveHashedLoginKey`: Replace `blake3Hash` with `sha256Hash`,
      `blake3Mac` with `sha256Hmac`, `blake3Pbkdf` with `sha256Pbkdf`

### Update encryption functions

- [x] `hashKey`: Replace `blake3Hash` with `sha256Hash`
- [x] `encryptKey`: Replace `acb3Encrypt` with `acs2Encrypt`
- [x] `decryptKey`: Replace `acb3Decrypt` with `acs2Decrypt`
- [x] `encryptPassword`: Replace `acb3Encrypt` with `acs2Encrypt`
- [x] `decryptPassword`: Replace `acb3Decrypt` with `acs2Decrypt`

### Update JSDoc comments

- [x] Update all JSDoc comments that reference "Blake3" to reference "SHA-256"
- [x] Update comment for `sha256Pbkdf` to explain it uses SHA-256 HMAC

---

## Phase 3: Update API Server Procedures

### api-server/src/procedures/login.ts

- [x] Replace `import { blake3Hash } from "@webbuf/blake3"` with
      `import { sha256Hash } from "@webbuf/sha256"`
- [x] Replace `blake3Hash(...)` calls with `sha256Hash(...)`

### api-server/src/procedures/logout.ts

- [x] Replace `import { blake3Hash } from "@webbuf/blake3"` with
      `import { sha256Hash } from "@webbuf/sha256"`
- [x] Replace `blake3Hash(...)` calls with `sha256Hash(...)`

### api-server/src/procedures/base.ts

- [x] Update any comments referencing Blake3 to reference SHA-256

### api-server/src/procedures/register-vault.ts

- [x] Update any comments referencing Blake3 to reference SHA-256

---

## Phase 4: Update Test Files

### lib/test/index.test.ts

- [ ] Update imports from blake3/acb3 to sha256/acs2
- [ ] Update test descriptions that mention "blake3" to "sha256"
- [ ] Update expected hash values (SHA-256 produces different output than
      Blake3)
- [ ] Verify all tests pass with new hash values

### api-server/test/vault.test.ts

- [ ] Replace `import { blake3Hash } from "@webbuf/blake3"` with
      `import { sha256Hash } from "@webbuf/sha256"`
- [ ] Replace `blake3Hash(...)` calls with `sha256Hash(...)`

### api-server/test/auth.test.ts

- [ ] Replace `import { blake3Hash } from "@webbuf/blake3"` with
      `import { sha256Hash } from "@webbuf/sha256"`
- [ ] Replace `blake3Hash(...)` calls with `sha256Hash(...)`

### api-server/test/device-session.test.ts

- [ ] Replace `import { blake3Hash } from "@webbuf/blake3"` with
      `import { sha256Hash } from "@webbuf/sha256"`
- [ ] Replace `blake3Hash(...)` calls with `sha256Hash(...)`

---

## Phase 5: Update Tauri App

### tauri-ts/app/routes/new-vault.3.tsx

- [ ] Update import from `blake3Hash` to `sha256Hash` (from @keypears/lib)
- [ ] Replace `blake3Hash(...)` calls with `sha256Hash(...)`

### tauri-ts/app/lib/vault-crypto.ts

- [ ] Update import from `blake3Hash` to `sha256Hash` (from @keypears/lib)
- [ ] Replace `blake3Hash(...)` calls with `sha256Hash(...)`

### tauri-ts/app/lib/secret-encryption.ts

- [ ] Check for any acb3/blake3 usage and update to acs2/sha256

---

## Phase 6: Update Documentation

### docs/crypto.md (major rewrite)

- [ ] Replace all "Blake3" references with "SHA-256"
- [ ] Replace all "blake3Hash" with "sha256Hash"
- [ ] Replace all "blake3Mac" with "sha256Hmac"
- [ ] Replace all "blake3Pbkdf" with "sha256Pbkdf"
- [ ] Replace all "ACB3" with "ACS2"
- [ ] Update diagrams showing key derivation
- [ ] Update code examples

### docs/auth.md

- [ ] Replace any "blake3" references with "sha256"

### docs/mvp.md

- [ ] Replace any "blake3" references with "sha256"

### docs/deployment.md

- [ ] Replace any "blake3" references with "sha256"

### AGENTS.md

- [ ] Update cryptography section to reference SHA-256 instead of Blake3
- [ ] Update algorithm list (Blake3 → SHA-256, ACB3 → ACS2)

### README.md

- [ ] Update any blake3 references to sha256

---

## Phase 7: Build and Test

### Build packages

- [ ] Run `pnpm --filter @keypears/lib run lint`
- [ ] Run `pnpm --filter @keypears/lib run typecheck`
- [ ] Run `pnpm --filter @keypears/lib run build`
- [ ] Run `pnpm --filter @keypears/lib run test`

### Build and test api-server

- [ ] Run `pnpm --filter @keypears/api-server run lint`
- [ ] Run `pnpm --filter @keypears/api-server run typecheck`
- [ ] Run `pnpm --filter @keypears/api-server run build`
- [ ] Start test server: `pnpm --filter @keypears/api-server run test:server`
- [ ] Run `pnpm --filter @keypears/api-server run test`

### Verify Tauri app

- [ ] Run `pnpm --filter keypears-tauri run typecheck`

### Verify webapp

- [ ] Run `pnpm --filter @keypears/webapp run typecheck`

---

## Phase 8: Blog Post (Future)

After migration is complete, write a blog post explaining the switch:

- [ ] Create `webapp/markdown/blog/YYYY-MM-DD-switching-to-sha256.md`
- [ ] Explain rationale (industry standard compliance)
- [ ] Acknowledge Blake3 is technically excellent
- [ ] Explain that for our use case, SHA-256 performance is sufficient
- [ ] Emphasize that security is equivalent (both 256-bit)
- [ ] Run `pnpm --filter @keypears/webapp run build:blog` to regenerate feeds

---

## Files NOT to Modify

These blog posts mention Blake3 in historical context and should remain
unchanged:

- `webapp/markdown/blog/2025-11-16-typescript-for-mvp.md`
- `webapp/markdown/blog/2025-10-25-rust-backend-architecture.md`
- `webapp/markdown/blog/2025-10-05-vault-encryption-key-derivation.md`

---

## Notes

1. **Hash output size**: Both Blake3 and SHA-256 produce 32-byte hashes, so all
   `FixedBuf<32>` types remain unchanged.

2. **API compatibility**: The webbuf SHA-256 functions have identical signatures
   to Blake3 functions, making this a straightforward find-and-replace.

3. **Salt strings**: The context strings like `"KeyPears password salt v1"` do
   not need to change - they are domain separators, not algorithm identifiers.

4. **Performance**: SHA-256 is slightly slower than Blake3, but negligible for
   our use case where 100k KDF iterations dominate.
